pipeline {
    agent any

    parameters {
        string(name: "App_Version", description: "Provide application version")
    }

    environment {
        DOCKERHUB_CREDENTIALS = credentials("dockerhub")
    }

    options {
        timestamps()
    }

    stages {

        stage("Repo Clone") {
            steps {
                echo "===== CLONING REPO ====="
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/master"]],
                    userRemoteConfigs: [[url: "https://github.com/abhishekdhaiskar/DataStore.git"]]
                ])
            }
        }

        stage("Maven Build") {
            steps {
                echo "===== MAVEN BUILD ====="
                sh "mvn clean package -DskipTests"
            }
        }

        stage("Maven Test") {
            steps {
                echo "===== MAVEN TEST ====="
                sh "mvn test"
            }
        }

        stage("Artifact Store") {
            steps {
                withAWS(credentials: 'aws-creds', region: 'ap-south-1') {
                    sh """
                        set -x

                        echo "===== UPLOADING TO S3 ====="

                        echo "Checking target folder..."
                        ls -lh target || true

                        echo "Checking bucket access..."
                        aws s3 ls s3://datastore-application/ || true

                        echo "Uploading jar..."
                        aws s3 cp target/*.jar s3://datastore-application/ --region ap-south-1

                        echo "===== S3 UPLOAD DONE ====="
                    """
                }
            }
        }

        stage("Docker Image Build") {
            steps {
                sh "docker build -t datastore:${App_Version} ."
            }
        }

        stage("Docker Image Scan") {
            steps {
                sh "trivy image datastore:${App_Version}"
            }
        }

        stage("Docker Image Tag") {
            steps {
                sh "docker tag datastore:${App_Version} abhi9604/datastore:${App_Version}"
            }
        }

        stage("DockerHub Push") {
            steps {
                sh '''
                    echo "$DOCKERHUB_CREDENTIALS_PSW" | docker login -u "$DOCKERHUB_CREDENTIALS_USR" --password-stdin
                    docker push abhi9604/datastore:'"${App_Version}"'
                '''
            }
        }

        stage("Cleanup") {
            steps {
                sh "docker image prune -a -f"
            }
        }

        stage("Approval") {
            steps {
                input "Trigger downstream job?"
            }
        }

        stage("Trigger Deployment") {
            steps {
                build(
                    job: "KubernetesDeployment",
                    parameters: [
                        string(name: "App_Name", value: "datastore-deploy"),
                        string(name: "App_Version", value: params.App_Version)
                    ]
                )
            }
        }
    }
}
