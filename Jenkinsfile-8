pipeline {
    agent any

    parameters {
        string(name: "App_Version", description: "Provide application version")
    }

    environment {
        DOCKERHUB_CREDENTIALS = credentials("dockerhub")  // Jenkins Docker Hub credentials
    }

    stages {

        stage("Clone Repo") {
            steps {
                checkout scmGit(
                    branches: [[name: '*/master']],
                    extensions: [],
                    userRemoteConfigs: [[url: 'https://github.com/abhishekdhaiskar/DataStore.git']]
                )
            }
        }

        stage("Maven Build") {
            steps {
                sh '''
                    set -e
                    chmod +x mvnw
                    ./mvnw clean package -DskipTests
                '''
            }
        }

        stage("Maven Test") {
            steps {
                sh './mvnw test'
            }
        }

        stage("Artifact Store") {
            steps {
                sh 'aws s3 cp ./target/*.jar s3://datastore-application/'
            }
        }

        stage("Docker Build") {
            steps {
                sh "docker build -t datastore:${App_Version} -f Dockerfile ."
            }
        }

        stage("Docker Scan") {
            steps {
                sh "trivy image datastore:${App_Version}"
            }
        }

        stage("Docker Tag") {
            steps {
                sh "docker tag datastore:${App_Version} abhi9604/datastore:${App_Version}"
            }
        }

        stage("Docker Push") {
            steps {
                sh '''
                    docker login -u $DOCKERHUB_CREDENTIALS_USR -p $DOCKERHUB_CREDENTIALS_PSW
                    docker push abhi9604/datastore:${App_Version}
                '''
            }
        }

        stage("Cleanup") {
            steps {
                sh "docker image prune -a -f"
            }
        }

        stage("Deployment Approval") {
            steps {
                input "Trigger Downstream Job?"
            }
        }
    }
}
