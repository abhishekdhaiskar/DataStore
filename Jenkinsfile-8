pipeline {
    agent any

    parameters {
        string(name: "App_Version", defaultValue: "1.0.0", description: "Provide Application Version")
    }

    environment {
        DOCKERHUB = credentials("dockerhub")      // DockerHub credentials
        AWS_CREDS = credentials("aws-creds")      // AWS credentials
    }

    stages {

        stage("Clone Repo") {
            steps {
                git branch: 'master', url: 'https://github.com/abhishekdhaiskar/DataStore.git'
                sh "ls -la"
            }
        }

        stage("Maven Build") {
            steps {
                sh '''
                    chmod +x mvnw || true
                    ./mvnw clean package -DskipTests
                    ls -la target
                '''
            }
        }

        stage("Maven Test") {
            steps {
                sh "./mvnw test"
            }
        }

        stage("Artifact Store (S3)") {
            steps {
                withCredentials([usernamePassword(credentialsId: 'aws-creds',
                                                  usernameVariable: 'AWS_ACCESS_KEY_ID',
                                                  passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {

                    sh '''
                        export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                        export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

                        aws s3 cp ./target/*.jar s3://datastore-application/
                    '''
                }
            }
        }

        stage("Docker Build") {
            steps {
                sh "docker build -t datastore:${params.App_Version} -f Dockerfile ."
            }
        }

        stage("Docker Scan") {
            steps {
                sh "trivy image datastore:${params.App_Version} || true"
            }
        }

        stage("Docker Tag") {
            steps {
                sh "docker tag datastore:${params.App_Version} abhi9604/datastore:${params.App_Version}"
            }
        }

        stage("Docker Push") {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push abhi9604/datastore:'"${App_Version}"'
                    '''
                }
            }
        }

        stage("Cleanup") {
            steps {
                sh "docker image prune -a -f"
            }
        }

        stage("Deployment Approval") {
            steps {
                input "Trigger Downstream Job?"
            }
        }
    }
}
